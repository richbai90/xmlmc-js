"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = require("axios");
const tough_cookie_1 = require("tough-cookie");
const axiosCookieJarSupport = require("@3846masa/axios-cookiejar-support");
class Connection {
    /**
     * Create a connection. Defers to the private _connect method.
     * @param {string} server - IP or FQDN to send the requests to
     * @param {number} port - Port to use when sending the requests. For https use 443. Defaults to 5015.
     */
    constructor(server = 'localhost', port = 5015) {
        this.server = server;
        this.port = port;
        this.https = false;
        this.storeCookies = typeof window === 'undefined';
        if (this.storeCookies) {
            this._setupCookieJar(new tough_cookie_1.CookieJar(), axiosCookieJarSupport);
        }
        else {
            this._connect(server, port);
        }
    }
    /**
     * private connect method. Responsible for inferring https.
     * Creates an instance of axios to use to send requests to and from the server.
     * @param server
     * @param port
     * @returns {*}
     * @private
     */
    _connect(server, port) {
        let url;
        switch (port) {
            case 443:
                this.https = true;
                url = `https://${server}/sw/`;
                break;
            case 80:
                url = `http://${server}/sw/`;
                break;
            default:
                url = `http://${server}:${port}`;
        }
        this.endpoint = axios_1.default.create({
            baseURL: url,
            withCredentials: true,
            headers: {
                "Content-Type": "text/xmlmc",
                "Charset": "UTF-8",
                "Accept": "text/json",
                "Accept-Charset": "UTF-8",
                "Cache-Control": "no-cache",
            },
            transformResponse,
        });
    }
    /**
     * @param xmlmc
     * @returns {Promise.<Response>}
     * @throws Module importing error. Occurs if for some reason we were unable to require the underlying modules. Indicates a problem with the library, not the developer.
     */
    async sendRequest(xmlmc) {
        return new Promise((resolve, reject) => {
            const post = this.port === 80 || this.https ? '/xmlmc/' : '/sw';
            this.endpoint.post(post, xmlmc.toString(), { withCredentials: true }).then((response) => {
                response.data.status ? resolve(response.data) : reject(response.data);
            }).catch((err) => {
                reject(err);
            });
        });
    }
    _setupCookieJar(jar, axiosCookieJar) {
        axiosCookieJar(axios_1.default);
        // create the cookie jar we will use
        this.cookieJar = jar;
        // create an instnace of axios
        this._connect(this.server, this.port);
        // tell the instance to use the cookie jar
        this.endpoint.defaults.jar = this.cookieJar;
        // Automatically send the cookie with each request
        this.endpoint.defaults.withCredentials = true;
        const endpoint = this.endpoint;
        const defaultConfig = endpoint.defaults;
        // Pass the entire URL including the base URL with each post
        // todo: May not be neccessary, but could be good to do the same for get method as well.
        endpoint['post'] = (url, data, config) => {
            let requestConfig = Object.assign(config || {}, {
                method: 'POST',
                url: url.match(/^(\/)\w+/) ? (defaultConfig.baseURL ? defaultConfig.baseURL + url : url) : (url === "" ? (defaultConfig.baseURL || url) : url),
                data: data,
            });
            return endpoint.request(requestConfig);
        };
    }
}
exports.Connection = Connection;
function transformResponse(response) {
    let parsedResponse = JSON.parse(response);
    let { '@status': status, data, ...rest } = parsedResponse;
    parsedResponse = Object.assign({ status: status, params: {}, data: [] }, rest);
    data = isIterable(data) && data;
    if (data) {
        parsedResponse.data = handleDataParam(data);
        if (data.hasOwnProperty('metaData')) {
            parsedResponse.params.metadata = data.metaData;
        }
        if (data.hasOwnProperty('generatedId')) {
            parsedResponse.params.generatedId = data.generatedId;
        }
    }
    return parsedResponse;
}
function handleDataParam(data) {
    if (Array.isArray(data)) {
        return data;
    }
    if (data.hasOwnProperty('rowData')) {
        return (Array.isArray(data.rowData.row) && data.rowData.row) || [data.rowData.row];
    }
}
function isIterable(obj) {
    // checks for null and undefined
    if (obj == null) {
        return false;
    }
    return Object(obj) === obj || typeof obj[Symbol.iterator] === 'function';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQXdGO0FBRXhGLCtDQUF1QztBQUN2QywyRUFBNEU7QUFzQjVFO0lBU0k7Ozs7T0FJRztJQUNILFlBQVksU0FBaUIsV0FBVyxFQUFFLE9BQWUsSUFBSTtRQUN6RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sTUFBTSxLQUFLLFdBQVcsQ0FBQztRQUNsRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksd0JBQVMsRUFBRSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDakUsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssUUFBUSxDQUFDLE1BQWMsRUFBRSxJQUFZO1FBQ3pDLElBQUksR0FBRyxDQUFDO1FBQ1IsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNYLEtBQUssR0FBRztnQkFDSixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztnQkFDbEIsR0FBRyxHQUFHLFdBQVcsTUFBTSxNQUFNLENBQUM7Z0JBQzlCLEtBQUssQ0FBQztZQUNWLEtBQUssRUFBRTtnQkFDSCxHQUFHLEdBQUcsVUFBVSxNQUFNLE1BQU0sQ0FBQztnQkFDN0IsS0FBSyxDQUFDO1lBQ1Y7Z0JBQ0ksR0FBRyxHQUFHLFVBQVUsTUFBTSxJQUFJ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QztRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkYsQ0FBQztBQUNMLENBQUM7QUFFRCxvQkFBb0IsR0FBUTtJQUN4QixnQ0FBZ0M7SUFDaEMsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDZCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssVUFBVSxDQUFDO0FBQzdFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaHR0cCwge0F4aW9zRXJyb3IsIEF4aW9zSW5zdGFuY2UsIEF4aW9zUmVxdWVzdENvbmZpZywgQXhpb3NSZXNwb25zZX0gZnJvbSAnYXhpb3MnXG5pbXBvcnQge1JlcXVlc3R9IGZyb20gXCIuL1JlcXVlc3RcIjtcbmltcG9ydCB7Q29va2llSmFyfSBmcm9tIFwidG91Z2gtY29va2llXCI7XG5pbXBvcnQgYXhpb3NDb29raWVKYXJTdXBwb3J0ID0gcmVxdWlyZSgnQDM4NDZtYXNhL2F4aW9zLWNvb2tpZWphci1zdXBwb3J0Jyk7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVzcG9uc2VcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gc3RhdHVzXG4gKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zXG4gKi9cblxuLyoqXG4gKiBDbGFzcyByZXByZXNlbnRzIGEgc2VydmVyIGNvbm5lY3Rpb24uXG4gKiBSZXNwb25zaWJsZSBmb3IgbWFpbnRhaW5pbmcgYSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2ZXIuXG4gKiBFbnN1cmVzIHRoYXQgYSBjb29raWUgaXMgc2F2ZWQgZWFjaCB0aW1lIGEgcmVxdWVzdCBpcyBzZW50IGFuZCByZWNlaXZlZC5cbiAqL1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgWG1sbWNSZXNwb25zZSB7XG4gICAgW2luZGV4IDogc3RyaW5nXSA6IGFueTtcbiAgICBzdGF0dXM6IGJvb2xlYW47XG4gICAgZGF0YTogQXJyYXk8e1tpbmRleCA6IHN0cmluZ10gOiBzdHJpbmd9PjtcbiAgICBwYXJhbXM6IHtbaW5kZXggOiBzdHJpbmddIDogc3RyaW5nfTtcbn1cblxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb24ge1xuXG4gICAgcHJvdGVjdGVkIHNlcnZlcjogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBwb3J0OiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIGh0dHBzOiBib29sZWFuO1xuICAgIHByb3RlY3RlZCBzdG9yZUNvb2tpZXM6IGJvb2xlYW47XG4gICAgcHJvdGVjdGVkIGVuZHBvaW50OiBBeGlvc0luc3RhbmNlO1xuICAgIHByb3RlY3RlZCBjb29raWVKYXI6IENvb2tpZUphcjtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGNvbm5lY3Rpb24uIERlZmVycyB0byB0aGUgcHJpdmF0ZSBfY29ubmVjdCBtZXRob2QuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNlcnZlciAtIElQIG9yIEZRRE4gdG8gc2VuZCB0aGUgcmVxdWVzdHMgdG9cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcG9ydCAtIFBvcnQgdG8gdXNlIHdoZW4gc2VuZGluZyB0aGUgcmVxdWVzdHMuIEZvciBodHRwcyB1c2UgNDQzLiBEZWZhdWx0cyB0byA1MDE1LlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHNlcnZlcjogc3RyaW5nID0gJ2xvY2FsaG9zdCcsIHBvcnQ6IG51bWJlciA9IDUwMTUpIHtcbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSBzZXJ2ZXI7XG4gICAgICAgIHRoaXMucG9ydCA9IHBvcnQ7XG4gICAgICAgIHRoaXMuaHR0cHMgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdG9yZUNvb2tpZXMgPSB0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJztcbiAgICAgICAgaWYgKHRoaXMuc3RvcmVDb29raWVzKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXR1cENvb2tpZUphcihuZXcgQ29va2llSmFyKCksIGF4aW9zQ29va2llSmFyU3VwcG9ydCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9jb25uZWN0KHNlcnZlciwgcG9ydCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBwcml2YXRlIGNvbm5lY3QgbWV0aG9kLiBSZXNwb25zaWJsZSBmb3IgaW5mZXJyaW5nIGh0dHBzLlxuICAgICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgYXhpb3MgdG8gdXNlIHRvIHNlbmQgcmVxdWVzdHMgdG8gYW5kIGZyb20gdGhlIHNlcnZlci5cbiAgICAgKiBAcGFyYW0gc2VydmVyXG4gICAgICogQHBhcmFtIHBvcnRcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgX2Nvbm5lY3Qoc2VydmVyOiBzdHJpbmcsIHBvcnQ6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBsZXQgdXJsO1xuICAgICAgICBzd2l0Y2ggKHBvcnQpIHtcbiAgICAgICAgICAgIGNhc2UgNDQzOlxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHVybCA9IGBodHRwczovLyR7c2VydmVyfS9zdy9gO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSA4MDpcbiAgICAgICAgICAgICAgICB1cmwgPSBgaHR0cDovLyR7c2VydmVyfS9zdy9gO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB1cmwgPSBgaHR0cDovLyR7c2VydmVyfToke3BvcnR9YDtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgdGhpcy5lbmRwb2ludCA9IGh0dHAuY3JlYXRlKHtcbiAgICAgICAgICAgIGJhc2VVUkw6IHVybCxcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdHJ1ZSxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcInRleHQveG1sbWNcIixcbiAgICAgICAgICAgICAgICBcIkNoYXJzZXRcIjogXCJVVEYtOFwiLFxuICAgICAgICAgICAgICAgIFwiQWNjZXB0XCI6IFwidGV4dC9qc29uXCIsXG4gICAgICAgICAgICAgICAgXCJBY2NlcHQtQ2hhcnNldFwiOiBcIlVURi04XCIsXG4gICAgICAgICAgICAgICAgXCJDYWNoZS1Db250cm9sXCI6IFwibm8tY2FjaGVcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZSxcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0geG1sbWNcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48UmVzcG9uc2U+fVxuICAgICAqIEB0aHJvd3MgTW9kdWxlIGltcG9ydGluZyBlcnJvci4gT2NjdXJzIGlmIGZvciBzb21lIHJlYXNvbiB3ZSB3ZXJlIHVuYWJsZSB0byByZXF1aXJlIHRoZSB1bmRlcmx5aW5nIG1vZHVsZXMuIEluZGljYXRlcyBhIHByb2JsZW0gd2l0aCB0aGUgbGlicmFyeSwgbm90IHRoZSBkZXZlbG9wZXIuXG4gICAgICovXG4gICAgYXN5bmMgc2VuZFJlcXVlc3QoeG1sbWM6IFJlcXVlc3QpOiBQcm9taXNlPFhtbG1jUmVzcG9uc2U+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFhtbG1jUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBvc3Q6IHN0cmluZyA9IHRoaXMucG9ydCA9PT0gODAgfHwgdGhpcy5odHRwcyA/ICcveG1sbWMvJyA6ICcvc3cnO1xuICAgICAgICAgICAgdGhpcy5lbmRwb2ludC5wb3N0KHBvc3QsIHhtbG1jLnRvU3RyaW5nKCksIHt3aXRoQ3JlZGVudGlhbHM6IHRydWV9KS50aGVuKChyZXNwb25zZTogQXhpb3NSZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuc3RhdHVzID8gcmVzb2x2ZSg8WG1sbWNSZXNwb25zZT5yZXNwb25zZS5kYXRhKSA6IHJlamVjdChyZXNwb25zZS5kYXRhKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnI6IEF4aW9zRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIHByaXZhdGUgX3NldHVwQ29va2llSmFyKGphcjogQ29va2llSmFyLCBheGlvc0Nvb2tpZUphcjogKGluc3RhbmNlOiBBeGlvc0luc3RhbmNlKSA9PiBBeGlvc0luc3RhbmNlKTogdm9pZCB7XG4gICAgICAgIGF4aW9zQ29va2llSmFyKGh0dHApO1xuXG4gICAgICAgIC8vIGNyZWF0ZSB0aGUgY29va2llIGphciB3ZSB3aWxsIHVzZVxuICAgICAgICB0aGlzLmNvb2tpZUphciA9IGphcjtcbiAgICAgICAgLy8gY3JlYXRlIGFuIGluc3RuYWNlIG9mIGF4aW9zXG4gICAgICAgIHRoaXMuX2Nvbm5lY3QodGhpcy5zZXJ2ZXIsIHRoaXMucG9ydCk7XG4gICAgICAgIC8vIHRlbGwgdGhlIGluc3RhbmNlIHRvIHVzZSB0aGUgY29va2llIGphclxuICAgICAgICB0aGlzLmVuZHBvaW50LmRlZmF1bHRzLmphciA9IHRoaXMuY29va2llSmFyO1xuICAgICAgICAvLyBBdXRvbWF0aWNhbGx5IHNlbmQgdGhlIGNvb2tpZSB3aXRoIGVhY2ggcmVxdWVzdFxuICAgICAgICB0aGlzLmVuZHBvaW50LmRlZmF1bHRzLndpdGhDcmVkZW50aWFscyA9IHRydWU7XG5cbiAgICAgICAgY29uc3QgZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50O1xuICAgICAgICBjb25zdCBkZWZhdWx0Q29uZmlnID0gZW5kcG9pbnQuZGVmYXVsdHM7XG5cbiAgICAgICAgLy8gUGFzcyB0aGUgZW50aXJlIFVSTCBpbmNsdWRpbmcgdGhlIGJhc2UgVVJMIHdpdGggZWFjaCBwb3N0XG4gICAgICAgIC8vIHRvZG86IE1heSBub3QgYmUgbmVjY2Vzc2FyeSwgYnV0IGNvdWxkIGJlIGdvb2QgdG8gZG8gdGhlIHNhbWUgZm9yIGdldCBtZXRob2QgYXMgd2VsbC5cblxuXG4gICAgICAgIGVuZHBvaW50Wydwb3N0J10gPSAodXJsOiBzdHJpbmcsIGRhdGE6IEF4aW9zUmVzcG9uc2VbJ2RhdGEnXSwgY29uZmlnOiBBeGlvc1JlcXVlc3RDb25maWcpID0+IHtcbiAgICAgICAgICAgIGxldCByZXF1ZXN0Q29uZmlnID0gT2JqZWN0LmFzc2lnbihjb25maWcgfHwge30sIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICB1cmw6IHVybC5tYXRjaCgvXihcXC8pXFx3Ky8pID8gKGRlZmF1bHRDb25maWcuYmFzZVVSTCA/IGRlZmF1bHRDb25maWcuYmFzZVVSTCArIHVybCA6IHVybCkgOiAodXJsID09PSBcIlwiID8gKGRlZmF1bHRDb25maWcuYmFzZVVSTCB8fCB1cmwpIDogdXJsKSxcbiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZW5kcG9pbnQucmVxdWVzdChyZXF1ZXN0Q29uZmlnKVxuICAgICAgICB9XG5cbiAgICB9XG59XG5cbmZ1bmN0aW9uIHRyYW5zZm9ybVJlc3BvbnNlKHJlc3BvbnNlOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFyc2VkUmVzcG9uc2U6IEF4aW9zUmVzcG9uc2VbJ2RhdGEnXSA9IEpTT04ucGFyc2UocmVzcG9uc2UpO1xuICAgIGxldCB7J0BzdGF0dXMnOiBzdGF0dXMsIGRhdGEsIC4uLnJlc3R9ID0gcGFyc2VkUmVzcG9uc2U7XG4gICAgcGFyc2VkUmVzcG9uc2UgPSBPYmplY3QuYXNzaWduKHtzdGF0dXM6IHN0YXR1cywgcGFyYW1zOiB7fSwgZGF0YTogW119LCByZXN0KTtcblxuICAgIGRhdGEgPSBpc0l0ZXJhYmxlKGRhdGEpICYmIGRhdGE7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgICAgcGFyc2VkUmVzcG9uc2UuZGF0YSA9IGhhbmRsZURhdGFQYXJhbShkYXRhKTtcblxuICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eSgnbWV0YURhdGEnKSkge1xuICAgICAgICAgICAgcGFyc2VkUmVzcG9uc2UucGFyYW1zLm1ldGFkYXRhID0gZGF0YS5tZXRhRGF0YTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KCdnZW5lcmF0ZWRJZCcpKSB7XG4gICAgICAgICAgICBwYXJzZWRSZXNwb25zZS5wYXJhbXMuZ2VuZXJhdGVkSWQgPSBkYXRhLmdlbmVyYXRlZElkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcnNlZFJlc3BvbnNlO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVEYXRhUGFyYW0oZGF0YTogQXhpb3NSZXNwb25zZVsnZGF0YSddKTogQXhpb3NSZXNwb25zZVsnZGF0YSddIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoJ3Jvd0RhdGEnKSkge1xuICAgICAgICByZXR1cm4gKEFycmF5LmlzQXJyYXkoZGF0YS5yb3dEYXRhLnJvdykgJiYgZGF0YS5yb3dEYXRhLnJvdykgfHwgW2RhdGEucm93RGF0YS5yb3ddO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaXNJdGVyYWJsZShvYmo6IGFueSk6IGJvb2xlYW4ge1xuICAgIC8vIGNoZWNrcyBmb3IgbnVsbCBhbmQgdW5kZWZpbmVkXG4gICAgaWYgKG9iaiA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0KG9iaikgPT09IG9iaiB8fCB0eXBlb2Ygb2JqW1N5bWJvbC5pdGVyYXRvcl0gPT09ICdmdW5jdGlvbic7XG59XG5cblxuIl19