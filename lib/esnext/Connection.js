"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = require("axios");
const tough_cookie_1 = require("tough-cookie");
const axiosCookieJarSupport = require("@3846masa/axios-cookiejar-support");
class Connection {
    /**
     * Create a connection. Defers to the private _connect method.
     * @param {string} server - IP or FQDN to send the requests to
     * @param {number} port - Port to use when sending the requests. For https use 443. Defaults to 5015.
     */
    constructor(server = 'localhost', port = 5015) {
        this.server = server;
        this.port = port;
        this.https = false;
        this.storeCookies = typeof window === 'undefined';
        if (this.storeCookies) {
            this._setupCookieJar(new tough_cookie_1.CookieJar(), axiosCookieJarSupport);
        }
        else {
            this._connect(server, port);
        }
    }
    /**
     * private connect method. Responsible for inferring https.
     * Creates an instance of axios to use to send requests to and from the server.
     * @param server
     * @param port
     * @returns {*}
     * @private
     */
    _connect(server, port) {
        let url;
        switch (port) {
            case 443:
                this.https = true;
                url = `https://${server}/sw/`;
                break;
            case 80:
                url = `http://${server}/sw/`;
                break;
            default:
                url = `http://${server}:${port}`;
        }
        this.endpoint = axios_1.default.create({
            baseURL: url,
            headers: {
                "Content-Type": "text/xmlmc",
                "Charset": "UTF-8",
                "Accept": "text/json",
                "Accept-Charset": "UTF-8",
                "Cache-Control": "no-cache",
            },
            transformResponse,
        });
    }
    /**
     * @param xmlmc
     * @returns {Promise.<Response>}
     * @throws Module importing error. Occurs if for some reason we were unable to require the underlying modules. Indicates a problem with the library, not the developer.
     */
    async sendRequest(xmlmc) {
        return new Promise((resolve, reject) => {
            const post = this.port === 80 || this.https ? '/xmlmc/' : '/sw';
            this.endpoint.post(post, xmlmc.toString()).then((response) => {
                response.data.status ? resolve(response.data) : reject(response.data);
            }).catch((err) => {
                reject(err);
            });
        });
    }
    _setupCookieJar(jar, axiosCookieJar) {
        axiosCookieJar(axios_1.default);
        // create the cookie jar we will use
        this.cookieJar = jar;
        // create an instnace of axios
        this._connect(this.server, this.port);
        // tell the instance to use the cookie jar
        this.endpoint.defaults.jar = this.cookieJar;
        // Automatically send the cookie with each request
        this.endpoint.defaults.withCredentials = true;
        const endpoint = this.endpoint;
        const defaultConfig = endpoint.defaults;
        // Pass the entire URL including the base URL with each post
        // todo: May not be neccessary, but could be good to do the same for get method as well.
        endpoint['post'] = (url, data, config) => {
            let requestConfig = Object.assign(config || {}, {
                method: 'POST',
                url: url.match(/^(\/)\w+/) ? (defaultConfig.baseURL ? defaultConfig.baseURL + url : url) : (url === "" ? (defaultConfig.baseURL || url) : url),
                data: data,
            });
            return endpoint.request(requestConfig);
        };
    }
}
exports.Connection = Connection;
function transformResponse(response) {
    let parsedResponse = JSON.parse(response);
    let { '@status': status, data, ...rest } = parsedResponse;
    parsedResponse = Object.assign({ status: status, params: {}, data: [] }, rest);
    data = isIterable(data) && data;
    if (data) {
        parsedResponse.data = handleDataParam(data);
        if (data.hasOwnProperty('metaData')) {
            parsedResponse.params.metadata = data.metaData;
        }
        if (data.hasOwnProperty('generatedId')) {
            parsedResponse.params.generatedId = data.generatedId;
        }
    }
    return parsedResponse;
}
function handleDataParam(data) {
    if (Array.isArray(data)) {
        return data;
    }
    if (data.hasOwnProperty('rowData')) {
        return (Array.isArray(data.rowData.row) && data.rowData.row) || [data.rowData.row];
    }
}
function isIterable(obj) {
    // checks for null and undefined
    if (obj == null) {
        return false;
    }
    return Object(obj) === obj || typeof obj[Symbol.iterator] === 'function';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQXdGO0FBRXhGLCtDQUF1QztBQUN2QywyRUFBNEU7QUFzQjVFO0lBU0k7Ozs7T0FJRztJQUNILFlBQVksU0FBaUIsV0FBVyxFQUFFLE9BQWUsSUFBSTtRQUN6RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sTUFBTSxLQUFLLFdBQVcsQ0FBQztRQUNsRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksd0JBQVMsRUFBRSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDakUsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssUUFBUSxDQUFDLE1BQWMsRUFBRSxJQUFZO1FBQ3pDLElBQUksR0FBRyxDQUFDO1FBQ1IsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNYLEtBQUssR0FBRztnQkFDSixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztnQkFDbEIsR0FBRyxHQUFHLFdBQVcsTUFBTSxNQUFNLENBQUM7Z0JBQzlCLEtBQUssQ0FBQztZQUNWLEtBQUssRUFBRTtnQkFDSCxHQUFHLEdBQUcsVUFBVSxNQUFNLE1BQU0sQ0FBQztnQkFDN0IsS0FBSyxDQUFDO1lBQ1Y7Z0JBQ0ksR0FBRyxHQUFHLFVBQVUsTUFBTSxJQUFJ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QyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2RixDQUFDO0FBQ0wsQ0FBQztBQUVELG9CQUFvQixHQUFRO0lBQ3hCLGdDQUFnQztJQUNoQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxVQUFVLENBQUM7QUFDN0UsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBodHRwLCB7QXhpb3NFcnJvciwgQXhpb3NJbnN0YW5jZSwgQXhpb3NSZXF1ZXN0Q29uZmlnLCBBeGlvc1Jlc3BvbnNlfSBmcm9tICdheGlvcydcbmltcG9ydCB7UmVxdWVzdH0gZnJvbSBcIi4vUmVxdWVzdFwiO1xuaW1wb3J0IHtDb29raWVKYXJ9IGZyb20gXCJ0b3VnaC1jb29raWVcIjtcbmltcG9ydCBheGlvc0Nvb2tpZUphclN1cHBvcnQgPSByZXF1aXJlKCdAMzg0Nm1hc2EvYXhpb3MtY29va2llamFyLXN1cHBvcnQnKTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBSZXNwb25zZVxuICogQHBhcmFtIHtib29sZWFufSBzdGF0dXNcbiAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAqL1xuXG4vKipcbiAqIENsYXNzIHJlcHJlc2VudHMgYSBzZXJ2ZXIgY29ubmVjdGlvbi5cbiAqIFJlc3BvbnNpYmxlIGZvciBtYWludGFpbmluZyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlci5cbiAqIEVuc3VyZXMgdGhhdCBhIGNvb2tpZSBpcyBzYXZlZCBlYWNoIHRpbWUgYSByZXF1ZXN0IGlzIHNlbnQgYW5kIHJlY2VpdmVkLlxuICovXG5cblxuZXhwb3J0IGludGVyZmFjZSBYbWxtY1Jlc3BvbnNlIHtcbiAgICBbaW5kZXggOiBzdHJpbmddIDogYW55O1xuICAgIHN0YXR1czogYm9vbGVhbjtcbiAgICBkYXRhOiBBcnJheTx7W2luZGV4IDogc3RyaW5nXSA6IHN0cmluZ30+O1xuICAgIHBhcmFtczoge1tpbmRleCA6IHN0cmluZ10gOiBzdHJpbmd9O1xufVxuXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvbiB7XG5cbiAgICBwcm90ZWN0ZWQgc2VydmVyOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIHBvcnQ6IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgaHR0cHM6IGJvb2xlYW47XG4gICAgcHJvdGVjdGVkIHN0b3JlQ29va2llczogYm9vbGVhbjtcbiAgICBwcm90ZWN0ZWQgZW5kcG9pbnQ6IEF4aW9zSW5zdGFuY2U7XG4gICAgcHJvdGVjdGVkIGNvb2tpZUphcjogQ29va2llSmFyO1xuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgY29ubmVjdGlvbi4gRGVmZXJzIHRvIHRoZSBwcml2YXRlIF9jb25uZWN0IG1ldGhvZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmVyIC0gSVAgb3IgRlFETiB0byBzZW5kIHRoZSByZXF1ZXN0cyB0b1xuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBwb3J0IC0gUG9ydCB0byB1c2Ugd2hlbiBzZW5kaW5nIHRoZSByZXF1ZXN0cy4gRm9yIGh0dHBzIHVzZSA0NDMuIERlZmF1bHRzIHRvIDUwMTUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioc2VydmVyOiBzdHJpbmcgPSAnbG9jYWxob3N0JywgcG9ydDogbnVtYmVyID0gNTAxNSkge1xuICAgICAgICB0aGlzLnNlcnZlciA9IHNlcnZlcjtcbiAgICAgICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICAgICAgdGhpcy5odHRwcyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnN0b3JlQ29va2llcyA9IHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnO1xuICAgICAgICBpZiAodGhpcy5zdG9yZUNvb2tpZXMpIHtcbiAgICAgICAgICAgIHRoaXMuX3NldHVwQ29va2llSmFyKG5ldyBDb29raWVKYXIoKSwgYXhpb3NDb29raWVKYXJTdXBwb3J0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Qoc2VydmVyLCBwb3J0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHByaXZhdGUgY29ubmVjdCBtZXRob2QuIFJlc3BvbnNpYmxlIGZvciBpbmZlcnJpbmcgaHR0cHMuXG4gICAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBheGlvcyB0byB1c2UgdG8gc2VuZCByZXF1ZXN0cyB0byBhbmQgZnJvbSB0aGUgc2VydmVyLlxuICAgICAqIEBwYXJhbSBzZXJ2ZXJcbiAgICAgKiBAcGFyYW0gcG9ydFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBfY29ubmVjdChzZXJ2ZXI6IHN0cmluZywgcG9ydDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGxldCB1cmw7XG4gICAgICAgIHN3aXRjaCAocG9ydCkge1xuICAgICAgICAgICAgY2FzZSA0NDM6XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgdXJsID0gYGh0dHBzOi8vJHtzZXJ2ZXJ9L3N3L2A7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDgwOlxuICAgICAgICAgICAgICAgIHVybCA9IGBodHRwOi8vJHtzZXJ2ZXJ9L3N3L2A7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHVybCA9IGBodHRwOi8vJHtzZXJ2ZXJ9OiR7cG9ydH1gO1xuICAgICAgICB9XG5cblxuICAgICAgICB0aGlzLmVuZHBvaW50ID0gaHR0cC5jcmVhdGUoe1xuICAgICAgICAgICAgYmFzZVVSTDogdXJsLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC94bWxtY1wiLFxuICAgICAgICAgICAgICAgIFwiQ2hhcnNldFwiOiBcIlVURi04XCIsXG4gICAgICAgICAgICAgICAgXCJBY2NlcHRcIjogXCJ0ZXh0L2pzb25cIixcbiAgICAgICAgICAgICAgICBcIkFjY2VwdC1DaGFyc2V0XCI6IFwiVVRGLThcIixcbiAgICAgICAgICAgICAgICBcIkNhY2hlLUNvbnRyb2xcIjogXCJuby1jYWNoZVwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlLFxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB4bWxtY1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxSZXNwb25zZT59XG4gICAgICogQHRocm93cyBNb2R1bGUgaW1wb3J0aW5nIGVycm9yLiBPY2N1cnMgaWYgZm9yIHNvbWUgcmVhc29uIHdlIHdlcmUgdW5hYmxlIHRvIHJlcXVpcmUgdGhlIHVuZGVybHlpbmcgbW9kdWxlcy4gSW5kaWNhdGVzIGEgcHJvYmxlbSB3aXRoIHRoZSBsaWJyYXJ5LCBub3QgdGhlIGRldmVsb3Blci5cbiAgICAgKi9cbiAgICBhc3luYyBzZW5kUmVxdWVzdCh4bWxtYzogUmVxdWVzdCk6IFByb21pc2U8QXhpb3NSZXNwb25zZVsnZGF0YSddIHwgQXhpb3NFcnJvcj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcG9zdDogc3RyaW5nID0gdGhpcy5wb3J0ID09PSA4MCB8fCB0aGlzLmh0dHBzID8gJy94bWxtYy8nIDogJy9zdyc7XG4gICAgICAgICAgICB0aGlzLmVuZHBvaW50LnBvc3QocG9zdCwgeG1sbWMudG9TdHJpbmcoKSkudGhlbigocmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnN0YXR1cyA/IHJlc29sdmUoPFhtbG1jUmVzcG9uc2U+cmVzcG9uc2UuZGF0YSkgOiByZWplY3QocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyOiBBeGlvc0Vycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zZXR1cENvb2tpZUphcihqYXI6IENvb2tpZUphciwgYXhpb3NDb29raWVKYXI6IChpbnN0YW5jZTogQXhpb3NJbnN0YW5jZSkgPT4gQXhpb3NJbnN0YW5jZSk6IHZvaWQge1xuICAgICAgICBheGlvc0Nvb2tpZUphcihodHRwKTtcblxuICAgICAgICAvLyBjcmVhdGUgdGhlIGNvb2tpZSBqYXIgd2Ugd2lsbCB1c2VcbiAgICAgICAgdGhpcy5jb29raWVKYXIgPSBqYXI7XG4gICAgICAgIC8vIGNyZWF0ZSBhbiBpbnN0bmFjZSBvZiBheGlvc1xuICAgICAgICB0aGlzLl9jb25uZWN0KHRoaXMuc2VydmVyLCB0aGlzLnBvcnQpO1xuICAgICAgICAvLyB0ZWxsIHRoZSBpbnN0YW5jZSB0byB1c2UgdGhlIGNvb2tpZSBqYXJcbiAgICAgICAgdGhpcy5lbmRwb2ludC5kZWZhdWx0cy5qYXIgPSB0aGlzLmNvb2tpZUphcjtcbiAgICAgICAgLy8gQXV0b21hdGljYWxseSBzZW5kIHRoZSBjb29raWUgd2l0aCBlYWNoIHJlcXVlc3RcbiAgICAgICAgdGhpcy5lbmRwb2ludC5kZWZhdWx0cy53aXRoQ3JlZGVudGlhbHMgPSB0cnVlO1xuXG4gICAgICAgIGNvbnN0IGVuZHBvaW50ID0gdGhpcy5lbmRwb2ludDtcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmZpZyA9IGVuZHBvaW50LmRlZmF1bHRzO1xuXG4gICAgICAgIC8vIFBhc3MgdGhlIGVudGlyZSBVUkwgaW5jbHVkaW5nIHRoZSBiYXNlIFVSTCB3aXRoIGVhY2ggcG9zdFxuICAgICAgICAvLyB0b2RvOiBNYXkgbm90IGJlIG5lY2Nlc3NhcnksIGJ1dCBjb3VsZCBiZSBnb29kIHRvIGRvIHRoZSBzYW1lIGZvciBnZXQgbWV0aG9kIGFzIHdlbGwuXG5cblxuICAgICAgICBlbmRwb2ludFsncG9zdCddID0gKHVybDogc3RyaW5nLCBkYXRhOiBBeGlvc1Jlc3BvbnNlWydkYXRhJ10sIGNvbmZpZzogQXhpb3NSZXF1ZXN0Q29uZmlnKSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVxdWVzdENvbmZpZyA9IE9iamVjdC5hc3NpZ24oY29uZmlnIHx8IHt9LCB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgdXJsOiB1cmwubWF0Y2goL14oXFwvKVxcdysvKSA/IChkZWZhdWx0Q29uZmlnLmJhc2VVUkwgPyBkZWZhdWx0Q29uZmlnLmJhc2VVUkwgKyB1cmwgOiB1cmwpIDogKHVybCA9PT0gXCJcIiA/IChkZWZhdWx0Q29uZmlnLmJhc2VVUkwgfHwgdXJsKSA6IHVybCksXG4gICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGVuZHBvaW50LnJlcXVlc3QocmVxdWVzdENvbmZpZylcbiAgICAgICAgfVxuXG4gICAgfVxufVxuXG5mdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZTogc3RyaW5nKSB7XG4gICAgbGV0IHBhcnNlZFJlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlWydkYXRhJ10gPSBKU09OLnBhcnNlKHJlc3BvbnNlKTtcbiAgICBsZXQgeydAc3RhdHVzJzogc3RhdHVzLCBkYXRhLCAuLi5yZXN0fSA9IHBhcnNlZFJlc3BvbnNlO1xuICAgIHBhcnNlZFJlc3BvbnNlID0gT2JqZWN0LmFzc2lnbih7c3RhdHVzOiBzdGF0dXMsIHBhcmFtczoge30sIGRhdGE6IFtdfSwgcmVzdCk7XG5cbiAgICBkYXRhID0gaXNJdGVyYWJsZShkYXRhKSAmJiBkYXRhO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICAgIHBhcnNlZFJlc3BvbnNlLmRhdGEgPSBoYW5kbGVEYXRhUGFyYW0oZGF0YSk7XG5cbiAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoJ21ldGFEYXRhJykpIHtcbiAgICAgICAgICAgIHBhcnNlZFJlc3BvbnNlLnBhcmFtcy5tZXRhZGF0YSA9IGRhdGEubWV0YURhdGE7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eSgnZ2VuZXJhdGVkSWQnKSkge1xuICAgICAgICAgICAgcGFyc2VkUmVzcG9uc2UucGFyYW1zLmdlbmVyYXRlZElkID0gZGF0YS5nZW5lcmF0ZWRJZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwYXJzZWRSZXNwb25zZTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlRGF0YVBhcmFtKGRhdGE6IEF4aW9zUmVzcG9uc2VbJ2RhdGEnXSk6IEF4aW9zUmVzcG9uc2VbJ2RhdGEnXSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KCdyb3dEYXRhJykpIHtcbiAgICAgICAgcmV0dXJuIChBcnJheS5pc0FycmF5KGRhdGEucm93RGF0YS5yb3cpICYmIGRhdGEucm93RGF0YS5yb3cpIHx8IFtkYXRhLnJvd0RhdGEucm93XTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGlzSXRlcmFibGUob2JqOiBhbnkpOiBib29sZWFuIHtcbiAgICAvLyBjaGVja3MgZm9yIG51bGwgYW5kIHVuZGVmaW5lZFxuICAgIGlmIChvYmogPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdChvYmopID09PSBvYmogfHwgdHlwZW9mIG9ialtTeW1ib2wuaXRlcmF0b3JdID09PSAnZnVuY3Rpb24nO1xufVxuXG5cbiJdfQ==